// Catalog of candidate dates from the user's CSV dataset (~every 5 days, 2016â€“2026).
// Used by Time Machine to find dates that produce signals.

import { computeAllHistoricalData } from './historical-calc';
import { calcSignalData, calcPeriod } from './signal-scoring';
import { DEFAULT_STOCKS } from './stock-defaults';

export const CATALOG_DATES = [
  '2016-03-05','2016-03-10','2016-03-15','2016-03-20','2016-03-25',
  '2016-04-05','2016-04-10','2016-04-15','2016-04-20','2016-04-25',
  '2016-05-05','2016-05-10','2016-05-15','2016-05-20','2016-05-25',
  '2016-06-05','2016-06-10','2016-06-15','2016-06-20','2016-06-25',
  '2016-07-05','2016-07-10','2016-07-15','2016-07-20','2016-07-25',
  '2016-08-05','2016-08-10','2016-08-15','2016-08-20','2016-08-25',
  '2016-09-05','2016-09-10','2016-09-15','2016-09-20','2016-09-25',
  '2016-10-05','2016-10-10','2016-10-15','2016-10-20','2016-10-25',
  '2016-11-05','2016-11-10','2016-11-15','2016-11-20','2016-11-25',
  '2016-12-05','2016-12-10','2016-12-15','2016-12-20','2016-12-25',
  '2017-01-05','2017-01-10','2017-01-15','2017-01-20','2017-01-25',
  '2017-02-05','2017-02-10','2017-02-15','2017-02-20','2017-02-25',
  '2017-03-05','2017-03-10','2017-03-15','2017-03-20','2017-03-25',
  '2017-04-05','2017-04-10','2017-04-15','2017-04-20','2017-04-25',
  '2017-05-05','2017-05-10','2017-05-15','2017-05-20','2017-05-25',
  '2017-06-05','2017-06-10','2017-06-15','2017-06-20','2017-06-25',
  '2017-07-05','2017-07-10','2017-07-15','2017-07-20','2017-07-25',
  '2017-08-05','2017-08-10','2017-08-15','2017-08-20','2017-08-25',
  '2017-09-05','2017-09-10','2017-09-15','2017-09-20','2017-09-25',
  '2017-10-05','2017-10-10','2017-10-15','2017-10-20','2017-10-25',
  '2017-11-05','2017-11-10','2017-11-15','2017-11-20','2017-11-25',
  '2017-12-05','2017-12-10','2017-12-15','2017-12-20','2017-12-25',
  '2018-01-05','2018-01-10','2018-01-15','2018-01-20','2018-01-25',
  '2018-02-05','2018-02-10','2018-02-15','2018-02-20','2018-02-25',
  '2018-03-05','2018-03-10','2018-03-15','2018-03-20','2018-03-25',
  '2018-04-05','2018-04-10','2018-04-15','2018-04-20','2018-04-25',
  '2018-05-05','2018-05-10','2018-05-15','2018-05-20','2018-05-25',
  '2018-06-05','2018-06-10','2018-06-15','2018-06-20','2018-06-25',
  '2018-07-05','2018-07-10','2018-07-15','2018-07-20','2018-07-25',
  '2018-08-05','2018-08-10','2018-08-15','2018-08-20','2018-08-25',
  '2018-09-05','2018-09-10','2018-09-15','2018-09-20','2018-09-25',
  '2018-10-05','2018-10-10','2018-10-15','2018-10-20','2018-10-25',
  '2018-11-05','2018-11-10','2018-11-15','2018-11-20','2018-11-25',
  '2018-12-05','2018-12-10','2018-12-15','2018-12-20','2018-12-25',
  '2019-01-05','2019-01-10','2019-01-15','2019-01-20','2019-01-25',
  '2019-02-05','2019-02-10','2019-02-15','2019-02-20','2019-02-25',
  '2019-03-05','2019-03-10','2019-03-15','2019-03-20','2019-03-25',
  '2019-04-05','2019-04-10','2019-04-15','2019-04-20','2019-04-25',
  '2019-05-05','2019-05-10','2019-05-15','2019-05-20','2019-05-25',
  '2019-06-05','2019-06-10','2019-06-15','2019-06-20','2019-06-25',
  '2019-07-05','2019-07-10','2019-07-15','2019-07-20','2019-07-25',
  '2019-08-05','2019-08-10','2019-08-15','2019-08-20','2019-08-25',
  '2019-09-05','2019-09-10','2019-09-15','2019-09-20','2019-09-25',
  '2019-10-05','2019-10-10','2019-10-15','2019-10-20','2019-10-25',
  '2019-11-05','2019-11-10','2019-11-15','2019-11-20','2019-11-25',
  '2019-12-05','2019-12-10','2019-12-15','2019-12-20','2019-12-25',
  '2020-01-05','2020-01-10','2020-01-15','2020-01-20','2020-01-25',
  '2020-02-05','2020-02-10','2020-02-15','2020-02-20','2020-02-25',
  '2020-03-05','2020-03-10','2020-03-15','2020-03-20','2020-03-25',
  '2020-04-05','2020-04-10','2020-04-15','2020-04-20','2020-04-25',
  '2020-05-05','2020-05-10','2020-05-15','2020-05-20','2020-05-25',
  '2020-06-05','2020-06-10','2020-06-15','2020-06-20','2020-06-25',
  '2020-07-05','2020-07-10','2020-07-15','2020-07-20','2020-07-25',
  '2020-08-05','2020-08-10','2020-08-15','2020-08-20','2020-08-25',
  '2020-09-05','2020-09-10','2020-09-15','2020-09-20','2020-09-25',
  '2020-10-05','2020-10-10','2020-10-15','2020-10-20','2020-10-25',
  '2020-11-05','2020-11-10','2020-11-15','2020-11-20','2020-11-25',
  '2020-12-05','2020-12-10','2020-12-15','2020-12-20','2020-12-25',
  '2021-01-05','2021-01-10','2021-01-15','2021-01-20','2021-01-25',
  '2021-02-05','2021-02-10','2021-02-15','2021-02-20','2021-02-25',
  '2021-03-05','2021-03-10','2021-03-15','2021-03-20','2021-03-25',
  '2021-04-05','2021-04-10','2021-04-15','2021-04-20','2021-04-25',
  '2021-05-05','2021-05-10','2021-05-15','2021-05-20','2021-05-25',
  '2021-06-05','2021-06-10','2021-06-15','2021-06-20','2021-06-25',
  '2021-07-05','2021-07-10','2021-07-15','2021-07-20','2021-07-25',
  '2021-08-05','2021-08-10','2021-08-15','2021-08-20','2021-08-25',
  '2021-09-05','2021-09-10','2021-09-15','2021-09-20','2021-09-25',
  '2021-10-05','2021-10-10','2021-10-15','2021-10-20','2021-10-25',
  '2021-11-05','2021-11-10','2021-11-15','2021-11-20','2021-11-25',
  '2021-12-05','2021-12-10','2021-12-15','2021-12-20','2021-12-25',
  '2022-01-05','2022-01-10','2022-01-15','2022-01-20','2022-01-25',
  '2022-02-05','2022-02-10','2022-02-15','2022-02-20','2022-02-25',
  '2022-03-05','2022-03-10','2022-03-15','2022-03-20','2022-03-25',
  '2022-04-05','2022-04-10','2022-04-15','2022-04-20','2022-04-25',
  '2022-05-05','2022-05-10','2022-05-15','2022-05-20','2022-05-25',
  '2022-06-05','2022-06-10','2022-06-15','2022-06-20','2022-06-25',
  '2022-07-05','2022-07-10','2022-07-15','2022-07-20','2022-07-25',
  '2022-08-05','2022-08-10','2022-08-15','2022-08-20','2022-08-25',
  '2022-09-05','2022-09-10','2022-09-15','2022-09-20','2022-09-25',
  '2022-10-05','2022-10-10','2022-10-15','2022-10-20','2022-10-25',
  '2022-11-05','2022-11-10','2022-11-15','2022-11-20','2022-11-25',
  '2022-12-05','2022-12-10','2022-12-15','2022-12-20','2022-12-25',
  '2023-01-05','2023-01-10','2023-01-15','2023-01-20','2023-01-25',
  '2023-02-05','2023-02-10','2023-02-15','2023-02-20','2023-02-25',
  '2023-03-05','2023-03-10','2023-03-15','2023-03-20','2023-03-25',
  '2023-04-05','2023-04-10','2023-04-15','2023-04-20','2023-04-25',
  '2023-05-05','2023-05-10','2023-05-15','2023-05-20','2023-05-25',
  '2023-06-05','2023-06-10','2023-06-15','2023-06-20','2023-06-25',
  '2023-07-05','2023-07-10','2023-07-15','2023-07-20','2023-07-25',
  '2023-08-05','2023-08-10','2023-08-15','2023-08-20','2023-08-25',
  '2023-09-05','2023-09-10','2023-09-15','2023-09-20','2023-09-25',
  '2023-10-05','2023-10-10','2023-10-15','2023-10-20','2023-10-25',
  '2023-11-05','2023-11-10','2023-11-15','2023-11-20','2023-11-25',
  '2023-12-05','2023-12-10','2023-12-15','2023-12-20','2023-12-25',
  '2024-01-05','2024-01-10','2024-01-15','2024-01-20','2024-01-25',
  '2024-02-05','2024-02-10','2024-02-15','2024-02-20','2024-02-25',
  '2024-03-05','2024-03-10','2024-03-15','2024-03-20','2024-03-25',
  '2024-04-05','2024-04-10','2024-04-15','2024-04-20','2024-04-25',
  '2024-05-05','2024-05-10','2024-05-15','2024-05-20','2024-05-25',
  '2024-06-05','2024-06-10','2024-06-15','2024-06-20','2024-06-25',
  '2024-07-05','2024-07-10','2024-07-15','2024-07-20','2024-07-25',
  '2024-08-05','2024-08-10','2024-08-15','2024-08-20','2024-08-25',
  '2024-09-05','2024-09-10','2024-09-15','2024-09-20','2024-09-25',
  '2024-10-05','2024-10-10','2024-10-15','2024-10-20','2024-10-25',
  '2024-11-05','2024-11-10','2024-11-15','2024-11-20','2024-11-25',
  '2024-12-05','2024-12-10','2024-12-15','2024-12-20','2024-12-25',
  '2025-01-05','2025-01-10','2025-01-15','2025-01-20','2025-01-25',
  '2025-02-05','2025-02-10','2025-02-15','2025-02-20','2025-02-25',
  '2025-03-05','2025-03-10','2025-03-15','2025-03-20','2025-03-25',
  '2025-04-05','2025-04-10','2025-04-15','2025-04-20','2025-04-25',
  '2025-05-05','2025-05-10','2025-05-15','2025-05-20','2025-05-25',
  '2025-06-05','2025-06-10','2025-06-15','2025-06-20','2025-06-25',
  '2025-07-05','2025-07-10','2025-07-15','2025-07-20','2025-07-25',
  '2025-08-05','2025-08-10','2025-08-15','2025-08-20','2025-08-25',
  '2025-09-05','2025-09-10','2025-09-15','2025-09-20','2025-09-25',
  '2025-10-05','2025-10-10','2025-10-15','2025-10-20','2025-10-25',
  '2025-11-05','2025-11-10','2025-11-15','2025-11-20','2025-11-25',
  '2025-12-05','2025-12-10','2025-12-15','2025-12-20','2025-12-25',
  '2026-01-05','2026-01-10','2026-01-15','2026-01-20','2026-01-25',
  '2026-02-05',
];

/**
 * Pre-scan all catalog dates to find which ones produce at least one signal.
 * A "signal" = GREEN (score >= 3) or YELLOW (score === 2 AND tier === 1).
 * @param {Object} historyData - Yahoo Finance history { [sym]: { timestamps, closes } }
 * @param {Array} currentStocks - Current live stock data (for current prices)
 * @returns {string[]} Sorted array of date strings that have at least one signal
 */
export function buildSignalDatesIndex(historyData, currentStocks) {
  const t0 = performance.now();
  const signalDates = [];

  for (const date of CATALOG_DATES) {
    const stocks = computeAllHistoricalData(historyData, date, currentStocks);
    if (!stocks || stocks.length === 0) continue;

    let hasSignal = false;
    for (const stock of stocks) {
      const periodInfo = calcPeriod(date, stock);
      const drawdownMode = stock.drawdownMode || 'NORMAL';
      const sig = calcSignalData(stock.price, stock.w52h, stock.w52l, stock.iv, periodInfo.period, drawdownMode);

      const isTier2 = stock.tier === 2;
      const isGreen = sig.score >= 3;
      const isYellow = !isTier2 && sig.score === 2;

      if (isGreen || isYellow) {
        hasSignal = true;
        break;
      }
    }

    if (hasSignal) {
      signalDates.push(date);
    }
  }

  const elapsed = (performance.now() - t0).toFixed(0);
  console.log(`[SignalCatalog] Built index: ${signalDates.length}/${CATALOG_DATES.length} dates have signals (${elapsed}ms)`);

  return signalDates;
}

/**
 * Find the nearest signal date strictly before the given date.
 * @param {string[]} signalDates - Pre-computed sorted signal dates
 * @param {string} currentDate - Current Time Machine date (YYYY-MM-DD)
 * @returns {string|null}
 */
export function findPrevSignalDate(signalDates, currentDate, minDaysBack = 10) {
  // Find the largest signal date that is at least minDaysBack before currentDate
  const cutoff = new Date(currentDate);
  cutoff.setDate(cutoff.getDate() - minDaysBack);
  const cutoffStr = cutoff.toISOString().slice(0, 10);

  // Binary search for largest date <= cutoffStr
  let lo = 0;
  let hi = signalDates.length - 1;
  let result = -1;

  while (lo <= hi) {
    const mid = (lo + hi) >> 1;
    if (signalDates[mid] <= cutoffStr) {
      result = mid;
      lo = mid + 1;
    } else {
      hi = mid - 1;
    }
  }

  return result >= 0 ? signalDates[result] : null;
}

/**
 * Find the nearest signal date strictly after the given date.
 * @param {string[]} signalDates - Pre-computed sorted signal dates
 * @param {string} currentDate - Current Time Machine date (YYYY-MM-DD)
 * @returns {string|null}
 */
export function findNextSignalDate(signalDates, currentDate) {
  // Binary search for smallest date > currentDate
  let lo = 0;
  let hi = signalDates.length - 1;
  let result = -1;

  while (lo <= hi) {
    const mid = (lo + hi) >> 1;
    if (signalDates[mid] > currentDate) {
      result = mid;
      hi = mid - 1;
    } else {
      lo = mid + 1;
    }
  }

  return result >= 0 ? signalDates[result] : null;
}
